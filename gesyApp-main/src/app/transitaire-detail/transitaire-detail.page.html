<div class="transitaire-container">
  <div class="transitaire-header">
    <div class="header-info">
      <h1>D√©tail Transitaire</h1>
      <p>Voyages assign√©s √† {{ transitaireInfo?.nom || '...' }}</p>
    </div>
    <div class="header-actions">
      @if (transitaireInfo) {
      <div class="transitaire-info">
        <span class="transitaire-name">{{ transitaireInfo.nom }}</span>
        <span class="transitaire-id">ID: {{ transitaireInfo.identifiant }}</span>
      </div>
      }
      <button class="btn-back" (click)="back()" type="button">
        <ion-icon name="arrow-back-outline"></ion-icon>
        <span>Retour √† la liste</span>
      </button>
    </div>
  </div>

  <!-- Statistiques -->
  <div class="stats-section">
    <div class="stat-card">
      <div class="stat-icon">
        <span>üöõ</span>
      </div>
      <div class="stat-content">
        <div class="stat-value">{{ stats.nombreCamionsDeclares }}</div>
        <div class="stat-label">Camions d√©clar√©s ce mois</div>
      </div>
    </div>
    <div class="stat-card">
      <div class="stat-icon">
        <span>üìã</span>
      </div>
      <div class="stat-content">
        <div class="stat-value">{{ stats.totalMontantT1 | number }} F</div>
        <div class="stat-label">Montant T1 ce mois</div>
      </div>
    </div>
    <div class="stat-card">
      <div class="stat-icon">
        <span>üí∞</span>
      </div>
      <div class="stat-content">
        <div class="stat-value">{{ stats.totalFraisDouane | number }} F</div>
        <div class="stat-label">Frais de douane ce mois</div>
      </div>
    </div>
  </div>

  <!-- Section Frais Douane -->
  <div class="douane-section">
    <div class="douane-card">
      <div class="douane-header">
        <h3>‚öôÔ∏è Frais de Douane</h3>
        <div class="douane-actions">
          <button class="btn-historique" (click)="toggleHistorique()">
            {{ showHistorique ? 'üìã Masquer historique' : 'üìã Voir historique' }}
          </button>
        </div>
      </div>

      @if (isLoadingDouane) {
        <div class="loading-message">Chargement...</div>
      } @else {
        <div class="douane-content">
          @if (!isEditingDouane) {
            <div class="douane-display">
              <div class="douane-item">
                <span class="douane-label">Frais par litre (Essence):</span>
                <span class="douane-value">{{ douane?.fraisParLitre | number }} FCFA</span>
              </div>
              <div class="douane-item">
                <span class="douane-label">Frais par litre (Gasoil):</span>
                <span class="douane-value">{{ douane?.fraisParLitreGasoil | number }} FCFA</span>
              </div>
              <div class="douane-item">
                <span class="douane-label">Frais T1:</span>
                <span class="douane-value">{{ douane?.fraisT1 | number }} FCFA</span>
              </div>
              <button class="btn-edit-douane" (click)="editDouane()">‚úèÔ∏è Modifier</button>
            </div>
          } @else {
            <div class="douane-form">
              <div class="form-row">
                <div class="form-group">
                  <label for="frais-essence">Frais par litre Essence (FCFA) *</label>
                  <input
                    id="frais-essence"
                    type="number"
                    [(ngModel)]="douaneForm.fraisParLitre"
                    min="0"
                    step="0.01"
                    required
                  />
                </div>
                <div class="form-group">
                  <label for="frais-gasoil">Frais par litre Gasoil (FCFA) *</label>
                  <input
                    id="frais-gasoil"
                    type="number"
                    [(ngModel)]="douaneForm.fraisParLitreGasoil"
                    min="0"
                    step="0.01"
                    required
                  />
                </div>
                <div class="form-group">
                  <label for="frais-t1">Frais T1 (FCFA) *</label>
                  <input
                    id="frais-t1"
                    type="number"
                    [(ngModel)]="douaneForm.fraisT1"
                    min="0"
                    step="0.01"
                    required
                  />
                </div>
              </div>
              <div class="form-actions">
                <button class="btn-cancel" (click)="cancelEditDouane()">Annuler</button>
                <button class="btn-save" (click)="saveDouane()">üíæ Enregistrer</button>
              </div>
            </div>
          }
        </div>
      }

      @if (showHistorique) {
        <div class="historique-section">
          <h4>üìú Historique des modifications</h4>
          @if (historiqueDouane.length === 0) {
            <p class="no-historique">Aucun historique disponible</p>
          } @else {
            <div class="historique-list">
              @for (h of historiqueDouane; track h.id) {
                <div class="historique-item">
                  <div class="historique-date">{{ formatDateTime(h.dateModification) }}</div>
                  <div class="historique-user">Par: {{ h.modifiePar }}</div>
                  <div class="historique-details">
                    <span>Essence: {{ h.ancienFraisParLitre | number }} ‚Üí {{ h.nouveauFraisParLitre | number }} FCFA</span>
                    <span>Gasoil: {{ h.ancienFraisParLitreGasoil | number }} ‚Üí {{ h.nouveauFraisParLitreGasoil | number }} FCFA</span>
                    <span>T1: {{ h.ancienFraisT1 | number }} ‚Üí {{ h.nouveauFraisT1 | number }} FCFA</span>
                  </div>
                </div>
              }
            </div>
          }
        </div>
      }
    </div>
  </div>

  <!-- Frais de douane par axe (Dakar: Diboli, Moussala; Abidjan: Kadiana, Zegoua) -->
  <div class="douane-section frais-axe-section">
    <div class="douane-card">
      <div class="douane-header">
        <h3>üõÉ Frais de douane par axe</h3>
        <div class="douane-actions">
          <button class="btn-add-frais-axe" (click)="openAddFraisAxeModal()" type="button">
            Ajouter (axe)
          </button>
        </div>
      </div>
      @if (isLoadingFraisAxe) {
        <div class="loading-message">Chargement...</div>
      } @else {
        <div class="frais-axe-content">
          @if (fraisDouaneAxes.length === 0) {
            <p class="no-frais-axe">Aucun frais par axe configur√©. Les d√©clarations utilisent les frais globaux ci-dessus.</p>
          } @else {
            @for (group of getFraxisByBureau(); track group.bureau) {
              <div class="frais-axe-bureau">
                <h4 class="bureau-title">{{ group.bureau }}</h4>
                <div class="frais-axe-list">
                  @for (f of group.items; track f.id) {
                    <div class="frais-axe-item">
                      <span class="frais-axe-nom">{{ f.axeNom }}</span>
                      <span class="frais-axe-values">
                        Essence: {{ f.fraisParLitre | number }} F/L ¬∑ Gasoil: {{ f.fraisParLitreGasoil | number }} F/L ¬∑ T1: {{ f.fraisT1 | number }} F
                      </span>
                      <button class="btn-edit-frais-axe" (click)="openEditFraisAxeModal(f)" type="button">Modifier</button>
                    </div>
                  }
                </div>
              </div>
            }
          }
        </div>
      }
    </div>
  </div>

  @if (showFraisAxeModal) {
  <div class="modal-overlay" (click)="closeFraisAxeModal()">
    <div class="modal-content frais-axe-modal" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2>{{ editingFraisAxe ? 'Modifier les frais (axe)' : 'Ajouter frais de douane (axe)' }}</h2>
        <button type="button" class="modal-close" (click)="closeFraisAxeModal()">√ó</button>
      </div>
      <div class="modal-body">
        @if (!editingFraisAxe) {
          <div class="form-group frais-axe-choice">
            <label class="toggle-label">
              <input type="checkbox" [(ngModel)]="createNewAxe" name="createNewAxe" />
              <span>Cr√©er un nouvel axe</span>
            </label>
          </div>
          @if (createNewAxe) {
            <div class="form-group">
              <label for="frais-axe-new-nom">Nom du nouvel axe *</label>
              <input id="frais-axe-new-nom" type="text" [(ngModel)]="newAxeNom" name="newAxeNom"
                class="form-input" placeholder="Ex: Diboli, Moussala, Kadiana, Zegoua" />
            </div>
          } @else {
            <div class="form-group">
              <label for="frais-axe-select">Axe existant *</label>
              <select id="frais-axe-select" [(ngModel)]="formFraisAxe.axeId" class="form-input">
                <option [ngValue]="undefined">S√©lectionner un axe</option>
                @for (a of axesSansFrais(); track a.id) {
                  <option [ngValue]="a.id">{{ a.nom }}</option>
                }
              </select>
              @if (axesSansFrais().length === 0) {
                <small class="form-hint">Aucun axe sans frais. Cochez ¬´ Cr√©er un nouvel axe ¬ª pour en ajouter un.</small>
              }
            </div>
          }
        } @else {
          <p class="frais-axe-edit-nom">Axe: <strong>{{ editingFraisAxe.axeNom }}</strong></p>
        }
        <div class="form-row">
          <div class="form-group">
            <label for="frais-axe-essence">Frais par litre Essence (FCFA)</label>
            <input id="frais-axe-essence" type="number" [(ngModel)]="formFraisAxe.fraisParLitre" min="0" step="0.01" class="form-input" />
          </div>
          <div class="form-group">
            <label for="frais-axe-gasoil">Frais par litre Gasoil (FCFA)</label>
            <input id="frais-axe-gasoil" type="number" [(ngModel)]="formFraisAxe.fraisParLitreGasoil" min="0" step="0.01" class="form-input" />
          </div>
        </div>
        <div class="form-group">
          <label for="frais-axe-t1">Frais T1 (FCFA)</label>
          <input id="frais-axe-t1" type="number" [(ngModel)]="formFraisAxe.fraisT1" min="0" step="0.01" class="form-input" />
        </div>
        <div class="modal-actions">
          <button type="button" class="btn-cancel" (click)="closeFraisAxeModal()">Annuler</button>
          <button type="button" class="btn-save" (click)="saveFraisAxe()" [disabled]="isSavingFraisAxe">
            {{ isSavingFraisAxe ? 'Enregistrement...' : 'Enregistrer' }}
          </button>
        </div>
      </div>
    </div>
  </div>
  }

  <div class="tabs-container">
    <div class="tabs">
      <button
        class="tab-btn"
        [class.active]="activeTab === 'en-cours'"
        (click)="setTab('en-cours')">
        <span>üìã</span>
        √Ä d√©clarer
      </button>
      <button
        class="tab-btn"
        [class.active]="activeTab === 'voyages-en-cours'"
        (click)="setTab('voyages-en-cours')">
        <span>üöõ</span>
        Voyages en cours
      </button>
      <button
        class="tab-btn"
        [class.active]="activeTab === 'archives'"
        (click)="setTab('archives')">
        <span>üì¶</span>
        Archives
      </button>
    </div>

    <div class="actions-bar">
      <div class="search-container">
        <input
          type="text"
          class="search-input"
          placeholder="Rechercher par num√©ro, client, destination..."
          [(ngModel)]="searchTerm"
          (input)="onSearchChange()"
        />
        <span class="search-icon">üîç</span>
      </div>

      @if (activeTab === 'en-cours' && filteredVoyages.length > 0) {
        <div class="bulk-actions">
          <button
            class="btn-select-all"
            (click)="toggleSelectAll()"
            [title]="selectAllTitle">
            {{ allVoyagesSelected ? '‚òëÔ∏è' : '‚òê' }}
            Tout s√©lectionner
          </button>
          @if (getSelectedCount() > 0) {
            @if (voyagesADeclarer.length > 0) {
              <button
                class="btn-declarer-tous"
                (click)="declarerTous()"
                [disabled]="isDeclaringMultiple">
                {{ isDeclaringMultiple ? 'D√©claration en cours...' : `D√©clarer tout (${getSelectedCount()})` }}
              </button>
            }
            <button
              class="btn-liberer-tous"
              (click)="libererTous()"
              [disabled]="isLiberingMultiple || getSelectedLibererCount() === 0">
              {{ isLiberingMultiple ? 'Lib√©ration en cours...' : `Lib√©rer la s√©lection (${getSelectedLibererCount()})` }}
            </button>
          }
        </div>
      }

      @if (activeTab === 'archives') {
        <div class="date-filters">
          <div class="filter-toggle">
            <label class="toggle-label">
              <input
                type="checkbox"
                [(ngModel)]="useDateRange"
                (change)="onDateFilterChange()"
              />
              <span>Intervalle de dates</span>
            </label>
          </div>

          @if (!useDateRange) {
            <div class="date-input-group">
              <label>Date:</label>
              <input
                type="date"
                [(ngModel)]="filterDate"
                (change)="onDateFilterChange()"
                class="date-input"
              />
            </div>
          } @else {
            <div class="date-input-group">
              <label>Du:</label>
              <input
                type="date"
                [(ngModel)]="filterStartDate"
                (change)="onDateFilterChange()"
                class="date-input"
              />
            </div>
            <div class="date-input-group">
              <label>Au:</label>
              <input
                type="date"
                [(ngModel)]="filterEndDate"
                (change)="onDateFilterChange()"
                class="date-input"
              />
            </div>
          }

          @if (filterDate || filterStartDate || filterEndDate) {
            <button class="btn-clear-filters" (click)="clearDateFilters()">
              Effacer
            </button>
          }
        </div>
      }
    </div>
  </div>

  <div class="table-container">
    <table class="voyages-table">
      <thead>
        <tr>
          @if (activeTab === 'en-cours') {
            <th class="checkbox-column">
              <input
                type="checkbox"
                [checked]="allVoyagesSelected"
                (change)="toggleSelectAll()"
                [title]="selectAllTitle"
              />
            </th>
          }
          <th>Num√©ro Voyage</th>
          <th>Camion</th>
          <th>Client</th>
          <th>Statut</th>
          <th>Type Produit</th>
          <th>Quantit√©</th>
          <th>D√©part</th>
          <th>Destination</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        @if (activeTab === 'voyages-en-cours') {
          @if (isLoadingEnCours) {
            <tr>
              <td colspan="9" class="empty-state">
                <div class="empty-message">Chargement...</div>
              </td>
            </tr>
          } @else if (voyagesEnCours.length === 0) {
            <tr>
              <td colspan="9" class="empty-state">
                <div class="empty-message">Aucun voyage en cours trouv√©</div>
              </td>
            </tr>
          } @else {
            @for (voyage of voyagesEnCours; track voyage.id) {
              <tr>
                <td><div class="voyage-numero">{{ voyage.numeroVoyage }}</div></td>
                <td>
                  <div class="camion-info">
                    <div class="truck-icon">üöõ</div>
                    <div class="camion-details">
                      <div class="camion-id">{{ voyage.camionImmatriculation || 'N/A' }}</div>
                    </div>
                  </div>
                </td>
                <td>
                  @if (voyage.clientNom) {
                    <div class="client-info">
                      <div class="client-avatar" [class]="'avatar-' + getClientColor(voyage.clientNom)">
                        {{ getClientInitiales(voyage.clientNom) }}
                      </div>
                      <div class="client-details">
                        <div class="client-nom">{{ voyage.clientNom }}</div>
                        <div class="client-email">{{ voyage.clientEmail || '' }}</div>
                      </div>
                    </div>
                  } @else {
                    <div class="no-client">-</div>
                  }
                </td>
                <td>
                  <span class="status-badge" [class]="getStatusClass(voyage.statut || '')">
                    {{ getStatusLabel(voyage.statut) }}
                  </span>
                </td>
                <td><div class="produit-type">{{ voyage.typeProduit || 'Essence' }}</div></td>
                <td><div class="quantite">{{ voyage.quantite }} L</div></td>
                <td><div class="date-value">{{ formatDate(voyage.dateDepart) }}</div></td>
                <td><div class="destination-value">{{ voyage.destination }}</div></td>
                <td>
                  <button class="action-btn" (click)="viewVoyage(voyage)" title="Voir le d√©tail">Voir</button>
                </td>
              </tr>
            }
          }
        } @else {
          @if (isLoading) {
            <tr>
              <td [attr.colspan]="activeTab === 'en-cours' ? 10 : 9" class="empty-state">
                <div class="empty-message">Chargement...</div>
              </td>
            </tr>
          } @else if (filteredVoyages.length === 0) {
            <tr>
              <td [attr.colspan]="activeTab === 'en-cours' ? 10 : 9" class="empty-state">
                <div class="empty-message">
                  Aucun voyage {{ activeTab === 'en-cours' ? '√† d√©clarer' : 'archiv√©' }} trouv√©
                </div>
              </td>
            </tr>
          } @else {
            @for (voyage of filteredVoyages; track voyage.id) {
            <tr>
              @if (activeTab === 'en-cours') {
                <td class="checkbox-column">
                  @if (voyage.statut === 'DOUANE') {
                    <input
                      type="checkbox"
                      [checked]="isVoyageSelected(voyage.id)"
                      (change)="toggleVoyageSelection(voyage.id)"
                    />
                  }
                </td>
              }
              <td>
                <div class="voyage-numero">{{ voyage.numeroVoyage }}</div>
              </td>
              <td>
                <div class="camion-info">
                  <div class="truck-icon">üöõ</div>
                  <div class="camion-details">
                    <div class="camion-id">{{ voyage.camionImmatriculation || 'N/A' }}</div>
                  </div>
                </div>
              </td>
              <td>
                @if (voyage.clientNom) {
                  <div class="client-info">
                    <div class="client-avatar" [class]="'avatar-' + getClientColor(voyage.clientNom)">
                      {{ getClientInitiales(voyage.clientNom) }}
                    </div>
                    <div class="client-details">
                      <div class="client-nom">{{ voyage.clientNom }}</div>
                      <div class="client-email">{{ voyage.clientEmail || '' }}</div>
                    </div>
                  </div>
                } @else {
                  <div class="no-client">-</div>
                }
              </td>
              <td>
                <div class="status-cell">
                  @if (activeTab === 'en-cours' && !voyage.declarer && voyage.statut === 'DOUANE') {
                    <button
                      class="btn-declarer"
                      (click)="declarerVoyage(voyage)"
                      title="D√©clarer le voyage">
                      D√©clarer
                    </button>
                  } @else {
                    <span class="status-badge" [class]="getStatusClass(voyage.statut || '')">
                      {{ getStatusLabel(voyage.statut) }}
                    </span>
                  }
                </div>
              </td>
              <td>
                <div class="produit-type">{{ voyage.typeProduit || 'Essence' }}</div>
              </td>
              <td>
                <div class="quantite">{{ voyage.quantite }} L</div>
              </td>
              <td>
                <div class="date-value">{{ formatDate(voyage.dateDepart) }}</div>
              </td>
              <td>
                <div class="destination-value">{{ voyage.destination }}</div>
              </td>
              <td>
                <div class="action-buttons">
                  @if (activeTab === 'en-cours') {
                    @if (voyage.liberer) {
                      <span class="status-badge badge-libere" title="Voyage lib√©r√©">Liber√©</span>
                    } @else if (voyage.declarer || voyage.passager === 'passer_non_declarer') {
                      <button
                        class="action-btn liberer-btn"
                        (click)="libererVoyage(voyage)"
                        title="Lib√©rer le voyage">
                        <span>Lib√©rer</span>
                      </button>
                    }
                    @if (!voyage.declarer && !voyage.passager && voyage.statut === 'DOUANE') {
                      <button class="action-btn passer-btn" (click)="passerNonDeclarer(voyage)" title="Passer non d√©clar√©">
                        <span>Passer non d√©clar√©</span>
                      </button>
                    }
                  }
                </div>
              </td>
            </tr>
          }
        }
        }
      </tbody>
    </table>

    @if (activeTab === 'voyages-en-cours' && totalPagesEnCours > 1) {
      <div class="pagination">
        <button
          class="pagination-btn"
          [disabled]="currentPageEnCours === 0"
          (click)="goToPageEnCours(currentPageEnCours - 1)">
          Pr√©c√©dent
        </button>
        <div class="pagination-info">
          Page {{ currentPageEnCours + 1 }} sur {{ totalPagesEnCours }} ({{ totalElementsEnCours }} √©l√©ments)
        </div>
        <button
          class="pagination-btn"
          [disabled]="currentPageEnCours >= totalPagesEnCours - 1"
          (click)="goToPageEnCours(currentPageEnCours + 1)">
          Suivant
        </button>
      </div>
    }

    @if (activeTab === 'archives' && totalPages > 1) {
      <div class="pagination">
        <button
          class="pagination-btn"
          [disabled]="currentPage === 0"
          (click)="previousPage()">
          Pr√©c√©dent
        </button>
        <div class="pagination-info">
          Page {{ currentPage + 1 }} sur {{ totalPages }} ({{ totalElements }} √©l√©ments)
        </div>
        <button
          class="pagination-btn"
          [disabled]="currentPage >= totalPages - 1"
          (click)="nextPage()">
          Suivant
        </button>
      </div>
    }
  </div>
</div>
