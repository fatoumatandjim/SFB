<div class="transitaire-container">
  <div class="transitaire-header">
    <div class="header-info">
      <h1>Interface Transitaire</h1>
      <p>Gestion de vos voyages assign√©s</p>
    </div>
    <div class="header-actions">
      @if (transitaireInfo) {
      <div class="transitaire-info">
        <span class="transitaire-name">{{ transitaireInfo.nom }}</span>
        <span class="transitaire-id">ID: {{ transitaireInfo.identifiant }}</span>
      </div>
      }
      <button class="btn-deconnexion" (click)="deconnecter()">
        <ion-icon name="log-out-outline"></ion-icon>
        <span>D√©connexion</span>
      </button>
    </div>
  </div>
  <!-- Statistiques -->
  <div class="stats-section">
    <div class="stat-card">
      <div class="stat-icon">
        <span>üöõ</span>
      </div>
      <div class="stat-content">
        <div class="stat-value">{{ stats.nombreCamionsDeclares }}</div>
        <div class="stat-label">Camions d√©clar√©s ce mois</div>
      </div>
    </div>
    <div class="stat-card">
      <div class="stat-icon">
        <span>üìã</span>
      </div>
      <div class="stat-content">
        <div class="stat-value">{{ stats.totalMontantT1 | number }} F</div>
        <div class="stat-label">Montant T1 ce mois</div>
      </div>
    </div>
    <div class="stat-card">
      <div class="stat-icon">
        <span>üí∞</span>
      </div>
      <div class="stat-content">
        <div class="stat-value">{{ stats.totalFraisDouane | number }} F</div>
        <div class="stat-label">Frais de douane ce mois</div>
      </div>
    </div>
  </div>


  <div class="tabs-container">
    <div class="tabs">
      <button
        class="tab-btn"
        [class.active]="activeTab === 'en-cours'"
        (click)="setTab('en-cours')">
        <span>üìã</span>
        √Ä d√©clarer
      </button>
      <button
        class="tab-btn"
        [class.active]="activeTab === 'voyages-en-cours'"
        (click)="setTab('voyages-en-cours')">
        <span>üöõ</span>
        Voyages en cours
      </button>
      <button
        class="tab-btn"
        [class.active]="activeTab === 'archives'"
        (click)="setTab('archives')">
        <span>üì¶</span>
        Archives
      </button>
      <button
        class="tab-btn"
        [class.active]="activeTab === 'axes'"
        (click)="setTab('axes')">
        <span>üß≠</span>
        Axes / Frais
      </button>
    </div>

    @if (activeTab !== 'axes') {
    <div class="actions-bar">
      <div class="search-container">
        <input
          type="text"
          class="search-input"
          placeholder="Rechercher par num√©ro, client, destination..."
          [(ngModel)]="searchTerm"
          (input)="onSearchChange()"
        />
        <span class="search-icon">üîç</span>
      </div>

      @if (activeTab === 'en-cours' && filteredVoyages.length > 0) {
        <div class="bulk-actions">
          <button
            class="btn-select-all"
            (click)="toggleSelectAll()"
            [title]="selectAllTitle">
            {{ allVoyagesSelected ? '‚òëÔ∏è' : '‚òê' }}
            Tout s√©lectionner
          </button>
          @if (getSelectedCount() > 0) {
            @if (voyagesADeclarer.length > 0) {
              <button
                class="btn-declarer-tous"
                (click)="declarerTous()"
                [disabled]="isDeclaringMultiple">
                {{ isDeclaringMultiple ? 'D√©claration en cours...' : `D√©clarer tout (${getSelectedCount()})` }}
              </button>
            }
            <button
              class="btn-liberer-tous"
              (click)="libererTous()"
              [disabled]="isLiberingMultiple || getSelectedLibererCount() === 0">
              {{ isLiberingMultiple ? 'Lib√©ration en cours...' : `Lib√©rer la s√©lection (${getSelectedLibererCount()})` }}
            </button>
          }
        </div>
      }

      @if (activeTab === 'archives') {
        <div class="date-filters">
          <div class="filter-toggle">
            <label class="toggle-label">
              <input
                type="checkbox"
                [(ngModel)]="useDateRange"
                (change)="onDateFilterChange()"
              />
              <span>Intervalle de dates</span>
            </label>
          </div>

          @if (!useDateRange) {
            <div class="date-input-group">
              <label>Date:</label>
              <input
                type="date"
                [(ngModel)]="filterDate"
                (change)="onDateFilterChange()"
                class="date-input"
              />
            </div>
          } @else {
            <div class="date-input-group">
              <label>Du:</label>
              <input
                type="date"
                [(ngModel)]="filterStartDate"
                (change)="onDateFilterChange()"
                class="date-input"
              />
            </div>
            <div class="date-input-group">
              <label>Au:</label>
              <input
                type="date"
                [(ngModel)]="filterEndDate"
                (change)="onDateFilterChange()"
                class="date-input"
              />
            </div>
          }

          @if (filterDate || filterStartDate || filterEndDate) {
            <button class="btn-clear-filters" (click)="clearDateFilters()">
              Effacer
            </button>
          }
        </div>
      }
    </div>
    }
  </div>

  @if (activeTab !== 'axes') {
  <div class="table-container">
    <table class="voyages-table">
      <thead>
        <tr>
          @if (activeTab === 'en-cours') {
            <th class="checkbox-column">
              <input
                type="checkbox"
                [checked]="allVoyagesSelected"
                (change)="toggleSelectAll()"
                [title]="selectAllTitle"
              />
            </th>
          }
          <th>Num√©ro Voyage</th>
          <th>Camion</th>
          <th>Client</th>
          <th>Statut</th>
          <th>Type Produit</th>
          <th>Quantit√©</th>
          <th>D√©part</th>
          <th>Destination</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        @if (activeTab === 'voyages-en-cours') {
          @if (isLoadingEnCours) {
            <tr>
              <td colspan="9" class="empty-state">
                <div class="empty-message">Chargement...</div>
              </td>
            </tr>
          } @else if (voyagesEnCours.length === 0) {
            <tr>
              <td colspan="9" class="empty-state">
                <div class="empty-message">Aucun voyage en cours (non d√©charg√©) trouv√©</div>
              </td>
            </tr>
          } @else {
            @for (voyage of voyagesEnCours; track voyage.id) {
              <tr>
                <td><div class="voyage-numero">{{ voyage.numeroVoyage }}</div></td>
                <td>
                  <div class="camion-info">
                    <div class="truck-icon">üöõ</div>
                    <div class="camion-details">
                      <div class="camion-id">{{ voyage.camionImmatriculation || 'N/A' }}</div>
                    </div>
                  </div>
                </td>
                <td>
                  @if (voyage.clientNom) {
                    <div class="client-info">
                      <div class="client-avatar" [class]="'avatar-' + getClientColor(voyage.clientNom)">
                        {{ getClientInitiales(voyage.clientNom) }}
                      </div>
                      <div class="client-details">
                        <div class="client-nom">{{ voyage.clientNom }}</div>
                        <div class="client-email">{{ voyage.clientEmail || '' }}</div>
                      </div>
                    </div>
                  } @else {
                    <div class="no-client">-</div>
                  }
                </td>
                <td>
                  @if (canDeclarer(voyage)) {
                    <button
                      type="button"
                      class="status-cell status-cell--button"
                      (click)="onStatutClick(voyage)"
                      [title]="'Cliquer pour d√©clarer le voyage ' + (voyage.numeroVoyage || '')">
                      <span class="status-badge" [class]="getStatusClass(voyage.statut || '')">
                        {{ getStatusLabel(voyage.statut, voyage.declarer, voyage.passager) }}
                      </span>
                    </button>
                  } @else {
                    <div class="status-cell">
                      <span class="status-badge" [class]="getStatusClass(voyage.statut || '')">
                        {{ getStatusLabel(voyage.statut, voyage.declarer, voyage.passager) }}
                      </span>
                    </div>
                  }
                </td>
                <td><div class="produit-type">{{ voyage.typeProduit || 'Essence' }}</div></td>
                <td><div class="quantite">{{ voyage.quantite }} L</div></td>
                <td><div class="date-value">{{ formatDate(voyage.dateDepart) }}</div></td>
                <td><div class="destination-value">{{ voyage.destination }}</div></td>
                <td>
                  <button class="action-btn" (click)="viewVoyage(voyage)" title="Voir le d√©tail">Voir</button>
                </td>
              </tr>
            }
          }
        } @else {
          @if (isLoading) {
            <tr>
              <td [attr.colspan]="activeTab === 'en-cours' ? 10 : 9" class="empty-state">
                <div class="empty-message">Chargement...</div>
              </td>
            </tr>
          } @else if (filteredVoyages.length === 0) {
            <tr>
              <td [attr.colspan]="activeTab === 'en-cours' ? 10 : 9" class="empty-state">
                <div class="empty-message">
                  Aucun voyage {{ activeTab === 'en-cours' ? '√† d√©clarer' : 'archiv√©' }} trouv√©
                </div>
              </td>
            </tr>
          } @else {
            @for (voyage of filteredVoyages; track voyage.id) {
              <tr>
                @if (activeTab === 'en-cours') {
                  <td class="checkbox-column">
                    @if (voyage.statut === 'DOUANE') {
                      <input
                        type="checkbox"
                        [checked]="isVoyageSelected(voyage.id)"
                        (change)="toggleVoyageSelection(voyage.id)"
                      />
                    }
                  </td>
                }
                <td>
                  <div class="voyage-numero">{{ voyage.numeroVoyage }}</div>
                </td>
                <td>
                  <div class="camion-info">
                    <div class="truck-icon">üöõ</div>
                    <div class="camion-details">
                      <div class="camion-id">{{ voyage.camionImmatriculation || 'N/A' }}</div>
                    </div>
                  </div>
                </td>
                <td>
                  @if (voyage.clientNom) {
                    <div class="client-info">
                      <div class="client-avatar" [class]="'avatar-' + getClientColor(voyage.clientNom)">
                        {{ getClientInitiales(voyage.clientNom) }}
                      </div>
                      <div class="client-details">
                        <div class="client-nom">{{ voyage.clientNom }}</div>
                        <div class="client-email">{{ voyage.clientEmail || '' }}</div>
                      </div>
                    </div>
                  } @else {
                    <div class="no-client">-</div>
                  }
                </td>
                <td>
                  @if (canDeclarer(voyage)) {
                    <button
                      type="button"
                      class="status-cell status-cell--button"
                      (click)="onStatutClick(voyage)"
                      [title]="'Cliquer pour d√©clarer le voyage ' + (voyage.numeroVoyage || '')">
                      <span class="status-badge" [class]="getStatusClass(voyage.statut || '')">
                        {{ getStatusLabel(voyage.statut, voyage.declarer, voyage.passager) }}
                      </span>
                    </button>
                  } @else {
                    <div class="status-cell">
                      <span class="status-badge" [class]="getStatusClass(voyage.statut || '')">
                        {{ getStatusLabel(voyage.statut, voyage.declarer, voyage.passager) }}
                      </span>
                    </div>
                  }
                </td>
                <td>
                  <div class="produit-type">{{ voyage.typeProduit || 'Essence' }}</div>
                </td>
                <td>
                  <div class="quantite">{{ voyage.quantite }} L</div>
                </td>
                <td>
                  <div class="date-value">{{ formatDate(voyage.dateDepart) }}</div>
                </td>
                <td>
                  <div class="destination-value">{{ voyage.destination }}</div>
                </td>
                <td>
                  <div class="action-buttons">
                    @if (activeTab === 'en-cours') {
                      @if (voyage.liberer) {
                        <span class="status-badge badge-libere" title="Voyage lib√©r√©">Liber√©</span>
                      } @else if (voyage.declarer || voyage.passager === 'passer_non_declarer') {
                        <button
                          class="action-btn liberer-btn"
                          (click)="libererVoyage(voyage)"
                          title="Lib√©rer le voyage">
                          <span>Lib√©rer</span>
                        </button>
                      }
                      @if (!voyage.declarer && !voyage.passager && voyage.statut === 'DOUANE') {
                        <button class="action-btn passer-btn" (click)="passerNonDeclarer(voyage)" title="Passer non d√©clar√©">
                          <span>Passer non d√©clar√©</span>
                        </button>
                      }
                    }
                  </div>
                </td>
              </tr>
            }
          }
        }
      </tbody>
    </table>

    @if (activeTab === 'voyages-en-cours' && totalPagesEnCours > 1) {
      <div class="pagination">
        <button
          class="pagination-btn"
          [disabled]="currentPageEnCours === 0"
          (click)="goToPageEnCours(currentPageEnCours - 1)">
          Pr√©c√©dent
        </button>
        <div class="pagination-info">
          Page {{ currentPageEnCours + 1 }} sur {{ totalPagesEnCours }} ({{ totalElementsEnCours }} √©l√©ments)
        </div>
        <button
          class="pagination-btn"
          [disabled]="currentPageEnCours >= totalPagesEnCours - 1"
          (click)="goToPageEnCours(currentPageEnCours + 1)">
          Suivant
        </button>
      </div>
    }

    @if (activeTab === 'archives' && totalPages > 1) {
      <div class="pagination">
        <button
          class="pagination-btn"
          [disabled]="currentPage === 0"
          (click)="previousPage()">
          Pr√©c√©dent
        </button>
        <div class="pagination-info">
          Page {{ currentPage + 1 }} sur {{ totalPages }} ({{ totalElements }} √©l√©ments)
        </div>
        <button
          class="pagination-btn"
          [disabled]="currentPage >= totalPages - 1"
          (click)="nextPage()">
          Suivant
        </button>
      </div>
    }
  </div>
  }

  @if (activeTab === 'axes') {
  <div class="axes-management-section">
    <app-axes></app-axes>
  </div>
  }
</div>

