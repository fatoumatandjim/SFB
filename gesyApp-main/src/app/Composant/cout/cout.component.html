<div class="cout-container">
  <div class="cout-header">
    <div>
      <h1>Calcul des Co√ªts de Transport</h1>
      <p>Gestion et suivi des co√ªts de transport par fournisseur</p>
    </div>
  </div>

  <!-- Filtres -->
  <div class="filters-section">
    <div class="filter-group">
      <label for="fournisseur-select">Fournisseur</label>
      <select
        id="fournisseur-select"
        class="filter-select"
        [(ngModel)]="selectedFournisseurId"
        (ngModelChange)="onFournisseurChange()">
        <option [ngValue]="null">S√©lectionner un fournisseur</option>
        @for (fournisseur of fournisseurs; track fournisseur.id) {
          <option [ngValue]="fournisseur.id">{{ fournisseur.nom }}</option>
        }
      </select>
    </div>

      <div class="filter-group">
        <label>Option</label>
        <div class="radio-group">
          <label class="radio-label">
            <input
              type="radio"
              name="filterOption"
              value="tous"
              [(ngModel)]="filterOption"
              (change)="onFilterOptionChange()"
            />
            <span>Tous</span>
          </label>
          <label class="radio-label">
            <input
              type="radio"
              name="filterOption"
              value="nonPaye"
              [(ngModel)]="filterOption"
              (change)="onFilterOptionChange()"
            />
            <span>Co√ªts non pay√©s</span>
          </label>
          <label class="radio-label">
            <input
              type="radio"
              name="filterOption"
              value="paye"
              [(ngModel)]="filterOption"
              (change)="onFilterOptionChange()"
            />
            <span>Co√ªts pay√©s</span>
          </label>
          <label class="radio-label">
            <input
              type="radio"
              name="filterOption"
              value="intervalle"
              [(ngModel)]="filterOption"
              (change)="onFilterOptionChange()"
            />
            <span>Sur intervalle</span>
          </label>
        </div>
      </div>

    @if (filterOption === 'intervalle') {
      <div class="filter-group date-range-group">
        <label>Intervalle de dates</label>
        <div class="date-inputs">
          <div class="date-input-wrapper">
            <label for="start-date">Du:</label>
            <input
              type="date"
              id="start-date"
              class="date-input"
              [(ngModel)]="filterStartDate"
              (change)="onDateRangeChange()"
            />
          </div>
          <div class="date-input-wrapper">
            <label for="end-date">Au:</label>
            <input
              type="date"
              id="end-date"
              class="date-input"
              [(ngModel)]="filterEndDate"
              (change)="onDateRangeChange()"
            />
          </div>
        </div>
      </div>
    }
  </div>

  <!-- Statistiques -->
  @if (selectedFournisseurId && couts.length > 0) {
    <div class="stats-cards">
      <div class="stat-card">
        <div class="stat-header">
          <div class="stat-icon blue">
            <span>üí∞</span>
          </div>
        </div>
        <div class="stat-value">{{ formatMontant(totalCout) }}</div>
        <div class="stat-label">Co√ªt Total</div>
      </div>

      <div class="stat-card">
        <div class="stat-header">
          <div class="stat-icon orange">
            <span>‚è≥</span>
          </div>
        </div>
        <div class="stat-value">{{ formatMontant(totalNonPaye) }}</div>
        <div class="stat-label">Non Pay√©</div>
      </div>

      <div class="stat-card">
        <div class="stat-header">
          <div class="stat-icon green">
            <span>‚úì</span>
          </div>
        </div>
        <div class="stat-value">{{ formatMontant(totalPaye) }}</div>
        <div class="stat-label">Pay√©</div>
      </div>
    </div>
  }

  <!-- Liste des co√ªts -->
  @if (isLoading) {
    <div class="loading-state">
      <p>Chargement des co√ªts...</p>
    </div>
  } @else if (selectedFournisseurId && couts.length === 0) {
    <div class="empty-state">
      <p><strong>Aucun co√ªt trouv√© pour les crit√®res s√©lectionn√©s.</strong></p>

      <div class="diagnostic">
        <p class="diagnostic-title">Diagnostic (donn√©es trouv√©es c√¥t√© backend)</p>
        @if (diagnosticIsLoading) {
          <p class="diagnostic-line">Chargement du diagnostic...</p>
        } @else if (diagnosticError) {
          <p class="diagnostic-line">{{ diagnosticError }}</p>
        } @else {
          <p class="diagnostic-line"><strong>Camions li√©s</strong> : {{ diagnosticCamionsCount }}</p>
          <p class="diagnostic-line"><strong>Voyages trouv√©s</strong> : {{ diagnosticVoyagesCount }}</p>
          <p class="diagnostic-line"><strong>Voyages hors cession</strong> : {{ diagnosticVoyagesNonCessionCount }}</p>
          @if (diagnosticCamionsCount > 0) {
            <div class="diagnostic-line">Camions :</div>
            <div class="diagnostic-pills">
              @for (c of diagnosticCamions; track c.id) {
                <span class="pill">
                  {{ c.immatriculation }} ({{ c.nombreVoyages || 0 }} / {{ c.nombreVoyagesNonCession || 0 }})
                </span>
              }
            </div>
          }
          @if (diagnosticVoyagesCount > 0 && diagnosticVoyagesNonCessionCount === 0) {
            <p class="diagnostic-hint">
              Il y a des voyages, mais <strong>tous sont en cession</strong> (donc exclus des co√ªts).
              Recr√©ez un voyage avec ¬´ cession ¬ª d√©coch√©, ou modifiez le flux pour que le voyage ne soit pas en cession.
            </p>
          } @else if (diagnosticVoyagesNonCessionCount > 0) {
            <p class="diagnostic-hint">
              Il y a des voyages hors cession, donc `GET /voyages/couts-transport` devrait renvoyer des lignes.
              Si ce n‚Äôest pas le cas, le probl√®me est plut√¥t c√¥t√© API (donn√©es du voyage, camion rattach√©, ou appel r√©seau).
            </p>
          } @else {
            <p class="diagnostic-hint">
              Les co√ªts sont calcul√©s √† partir des voyages des camions li√©s √† ce fournisseur.
              V√©rifiez que le voyage a √©t√© cr√©√© sur un camion li√© √† ce fournisseur.
            </p>
          }
        }
      </div>
    </div>
  } @else if (selectedFournisseurId && couts.length > 0) {
    <div class="couts-table-container">
      <table class="couts-table">
        <thead>
          <tr>
            <th>N¬∞ Voyage</th>
            <th>Camion</th>
            <th>Date D√©part</th>
            <th>Destination</th>
            <th>Quantit√© (L)</th>
            <th>Co√ªt Voyage</th>
            <th>Frais Totaux</th>
            <th>Co√ªt Total</th>
            <th>Statut Paiement</th>
            <th>Date Paiement</th>
          </tr>
        </thead>
        <tbody>
          @for (cout of couts; track cout.id) {
            <tr>
              <td>{{ cout.numeroVoyage || 'N/A' }}</td>
              <td>{{ cout.camionImmatriculation || 'N/A' }}</td>
              <td>{{ formatDate(cout.dateDepart) }}</td>
              <td>{{ cout.destination || 'N/A' }}</td>
              <td>{{ cout.quantite | number }}</td>
              <td>{{ formatMontant(cout.coutVoyage) }}</td>
              <td>{{ formatMontant(cout.fraisTotaux) }}</td>
              <td class="cout-total">{{ formatMontant(cout.coutTotal) }}</td>
              <td>
                <span [class]="getStatutPaiementClass(cout.statutPaiement)">
                  {{ getStatutPaiementLabel(cout.statutPaiement) }}
                </span>
              </td>
              <td>{{ formatDate(cout.datePaiement) }}</td>
            </tr>
          }
        </tbody>
        <tfoot>
          <tr>
            <td colspan="7" class="total-label">Total</td>
            <td class="total-value">{{ formatMontant(totalCout) }}</td>
            <td colspan="2"></td>
          </tr>
        </tfoot>
      </table>
    </div>
  } @else {
    <div class="empty-state">
      <p>Veuillez s√©lectionner un fournisseur pour afficher les co√ªts</p>
    </div>
  }
</div>
