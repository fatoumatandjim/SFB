<div class="cout-container">
  <div class="cout-header">
    <div>
      <h1>Calcul des Co√ªts de Transport</h1>
      <p>Gestion et suivi des co√ªts de transport par fournisseur</p>
    </div>
  </div>

  <!-- Filtres -->
  <div class="filters-section">
    <div class="filter-group">
      <label for="fournisseur-select">Fournisseur</label>
      <select
        id="fournisseur-select"
        class="filter-select"
        [(ngModel)]="selectedFournisseurId"
        (ngModelChange)="onFournisseurChange()">
        <option [ngValue]="null">S√©lectionner un fournisseur</option>
        @for (fournisseur of fournisseurs; track fournisseur.id) {
          <option [ngValue]="fournisseur.id">{{ fournisseur.nom }}</option>
        }
      </select>
    </div>

      <div class="filter-group">
        <label>Option</label>
        <div class="radio-group">
          <label class="radio-label">
            <input
              type="radio"
              name="filterOption"
              value="tous"
              [(ngModel)]="filterOption"
              (change)="onFilterOptionChange()"
            />
            <span>Tous</span>
          </label>
          <label class="radio-label">
            <input
              type="radio"
              name="filterOption"
              value="nonPaye"
              [(ngModel)]="filterOption"
              (change)="onFilterOptionChange()"
            />
            <span>Co√ªts non pay√©s</span>
          </label>
          <label class="radio-label">
            <input
              type="radio"
              name="filterOption"
              value="paye"
              [(ngModel)]="filterOption"
              (change)="onFilterOptionChange()"
            />
            <span>Co√ªts pay√©s</span>
          </label>
          <label class="radio-label">
            <input
              type="radio"
              name="filterOption"
              value="intervalle"
              [(ngModel)]="filterOption"
              (change)="onFilterOptionChange()"
            />
            <span>Sur intervalle</span>
          </label>
        </div>
      </div>

    @if (filterOption === 'intervalle') {
      <div class="filter-group date-range-group">
        <label>Intervalle de dates</label>
        <div class="date-inputs">
          <div class="date-input-wrapper">
            <label for="start-date">Du:</label>
            <input
              type="date"
              id="start-date"
              class="date-input"
              [(ngModel)]="filterStartDate"
              (change)="onDateRangeChange()"
            />
          </div>
          <div class="date-input-wrapper">
            <label for="end-date">Au:</label>
            <input
              type="date"
              id="end-date"
              class="date-input"
              [(ngModel)]="filterEndDate"
              (change)="onDateRangeChange()"
            />
          </div>
        </div>
      </div>
    }
  </div>

  <!-- Statistiques -->
  @if (selectedFournisseurId && couts.length > 0) {
    <div class="stats-cards">
      <div class="stat-card">
        <div class="stat-header">
          <div class="stat-icon blue">
            <span>üí∞</span>
          </div>
        </div>
        <div class="stat-value">{{ formatMontant(totalCout) }}</div>
        <div class="stat-label">Co√ªt Total</div>
      </div>

      <div class="stat-card">
        <div class="stat-header">
          <div class="stat-icon orange">
            <span>‚è≥</span>
          </div>
        </div>
        <div class="stat-value">{{ formatMontant(totalNonPaye) }}</div>
        <div class="stat-label">Non Pay√©</div>
      </div>

      <div class="stat-card">
        <div class="stat-header">
          <div class="stat-icon green">
            <span>‚úì</span>
          </div>
        </div>
        <div class="stat-value">{{ formatMontant(totalPaye) }}</div>
        <div class="stat-label">Pay√©</div>
      </div>
    </div>
  }

  <!-- Liste des co√ªts -->
  @if (isLoading) {
    <div class="loading-state">
      <p>Chargement des co√ªts...</p>
    </div>
  } @else if (selectedFournisseurId && couts.length === 0) {
    <div class="empty-state">
      <p><strong>Aucun co√ªt trouv√© pour les crit√®res s√©lectionn√©s.</strong></p>

      @if (coutsError) {
        <p class="error-text">{{ coutsError }}</p>
      }
    </div>
  } @else if (selectedFournisseurId && couts.length > 0) {
    <div class="couts-table-container">
      <table class="couts-table">
        <thead>
          <tr>
            <th>N¬∞ Voyage</th>
            <th>Camion</th>
            <th>Date D√©part</th>
            <th>Destination</th>
            <th>Quantit√© (L)</th>
            <th>Prix unit. (F/L)</th>
            <th>Co√ªt Voyage</th>
            <th>Frais Totaux</th>
            <th>Co√ªt Total</th>
            <th>Statut Paiement</th>
            <th>Date Paiement</th>
            @if (isComptable()) {
            <th>Action</th>
            }
          </tr>
        </thead>
        <tbody>
          @for (cout of couts; track cout.id) {
            <tr>
              <td>{{ cout.numeroVoyage || 'N/A' }}</td>
              <td>{{ cout.camionImmatriculation || 'N/A' }}</td>
              <td>{{ formatDate(cout.dateDepart) }}</td>
              <td>{{ cout.destination || 'N/A' }}</td>
              <td>{{ cout.quantite | number }}</td>
              <td>{{ cout.prixUnitaire != null ? (cout.prixUnitaire | number) + ' F' : 'N/A' }}</td>
              <td>{{ formatMontant(cout.coutVoyage) }}</td>
              <td>{{ formatMontant(cout.fraisTotaux) }}</td>
              <td class="cout-total">{{ formatMontant(cout.coutTotal) }}</td>
              <td>
                <span [class]="getStatutPaiementClass(cout.statutPaiement)">
                  {{ getStatutPaiementLabel(cout.statutPaiement) }}
                </span>
              </td>
              <td>{{ formatDate(cout.datePaiement) }}</td>
              @if (isComptable()) {
              <td>
                <button type="button" class="btn-edit-prix" (click)="openEditPrixModal(cout)" title="Modifier le prix unitaire">
                  üí∞
                </button>
              </td>
              }
            </tr>
          }
        </tbody>
        <tfoot>
          <tr>
            <td colspan="8" class="total-label">Total</td>
            <td class="total-value">{{ formatMontant(totalCout) }}</td>
            <td colspan="2"></td>
            @if (isComptable()) {
            <td></td>
            }
          </tr>
        </tfoot>
      </table>
    </div>
  } @else {
    <div class="empty-state">
      <p>Veuillez s√©lectionner un fournisseur pour afficher les co√ªts</p>
    </div>
  }

  @if (showEditPrixModal && editingCout) {
  <div class="modal-overlay" (click)="closeEditPrixModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2>Modifier le prix unitaire de transport</h2>
        <button class="modal-close" (click)="closeEditPrixModal()" aria-label="Fermer">√ó</button>
      </div>
      <div class="modal-body">
        <p class="modal-voyage-ref">Voyage {{ editingCout.numeroVoyage }} - {{ editingCout.quantite | number }} L</p>
        <div class="form-group">
          <label for="edit-prix-cout">Prix unitaire (FCFA/litre) *</label>
          <input
            type="number"
            id="edit-prix-cout"
            [(ngModel)]="editingPrixUnitaire"
            name="editingPrixUnitaire"
            min="1"
            step="1"
            placeholder="Ex: 25"
          />
        </div>
        <div class="modal-actions">
          <button type="button" class="btn-cancel" (click)="closeEditPrixModal()">Annuler</button>
          <button type="button" class="btn-submit" (click)="savePrixUnitaire()">
            Enregistrer
          </button>
        </div>
      </div>
    </div>
  </div>
  }
</div>
