<div class="depot-container">
  <div class="depot-header">
    <div>
      <h1>Gestion des D√©p√¥ts</h1>
      <p>Gestion de vos d√©p√¥ts et entrep√¥ts</p>
    </div>
    <div class="header-actions">
      @if (isLogistique) {
      <button class="btn-new-depot" (click)="nouveauDepot()">
        <span>+</span>
        Nouveau D√©p√¥t
      </button>
      }
    </div>
  </div>

  <div class="stats-cards">
    <div class="stat-card">
      <div class="stat-header">
        <div class="stat-icon blue">
          <span>üè≠</span>
        </div>
      </div>
      <div class="stat-value">{{ stats.total }}</div>
      <div class="stat-label">Total D√©p√¥ts</div>
    </div>

    <div class="stat-card">
      <div class="stat-header">
        <div class="stat-icon green">
          <span>‚úì</span>
        </div>
      </div>
      <div class="stat-value">{{ stats.actifs }}</div>
      <div class="stat-label">Actifs</div>
    </div>

    <div class="stat-card">
      <div class="stat-header">
        <div class="stat-icon purple">
          <span>üì¶</span>
        </div>
      </div>
      <div class="stat-value">{{ stats.stockTotal | number }}</div>
      <div class="stat-label">Stock Total (L)</div>
    </div>

    <!-- <div class="stat-card">
      <div class="stat-header">
        <div class="stat-icon orange">
          <span>üìä</span>
        </div>
      </div>
      <div class="stat-value">{{ stats.capaciteTotale | number }}</div>
      <div class="stat-label">Capacit√© Totale (L)</div>
    </div> -->
  </div>

  <div class="actions-bar">
    <!-- <div class="filters">
      <button
        class="filter-btn"
        [class.active]="activeFilter === 'tous'"
        (click)="setFilter('tous')">
        Tous
      </button>
      <button
        class="filter-btn"
        [class.active]="activeFilter === 'actifs'"
        (click)="setFilter('actifs')">
        Actifs
      </button>
      <button
        class="filter-btn"
        [class.active]="activeFilter === 'inactifs'"
        (click)="setFilter('inactifs')">
        Inactifs
      </button>
      <button
        class="filter-btn"
        [class.active]="activeFilter === 'maintenance'"
        (click)="setFilter('maintenance')">
        Maintenance
      </button>
    </div> -->

    <div class="search-container">
      <label for="search-depots" class="sr-only">Rechercher des d√©p√¥ts</label>
      <input
        type="text"
        id="search-depots"
        class="search-input"
        placeholder="Rechercher..."
        [(ngModel)]="searchTerm"
        aria-label="Rechercher des d√©p√¥ts"
      />
      <span class="search-icon">üîç</span>
    </div>
  </div>

  <div class="depots-grid">
    @if (isLoading) {
      <div class="loading-state">
        <div class="loading-spinner"></div>
        <p>Chargement des d√©p√¥ts...</p>
      </div>
    } @else if (filteredDepots.length === 0) {
      <div class="empty-state">
        <div class="empty-icon">üè≠</div>
        <h3>Aucun d√©p√¥t trouv√©</h3>
        <p>
          @if (searchTerm || activeFilter !== 'tous') {
            Aucun d√©p√¥t ne correspond √† vos crit√®res de recherche.
          } @else {
            Aucun d√©p√¥t n'a √©t√© enregistr√© pour le moment.
          }
        </p>
        @if (!searchTerm && activeFilter === 'tous') {
          <button class="btn-add-first" (click)="nouveauDepot()">
            <span>+</span>
            Ajouter le premier d√©p√¥t
          </button>
        }
      </div>
    } @else {
      @for (depot of filteredDepots; track depot.id) {
    <div class="depot-card">
      <div class="depot-card-header">
        <div class="depot-icon" [class]="'icon-' + depot.couleur">
          <span>üè≠</span>
        </div>
        <div class="depot-status" [class]="'status-' + (depot.statut?.toLowerCase() || 'actif')">
          @if (depot.statut === 'ACTIF') {
          Actif
          }
          @if (depot.statut === 'INACTIF') {
          Inactif
          }
          @if (depot.statut === 'EN_MAINTENANCE') {
          Maintenance
          }
          @if (depot.statut === 'PLEIN') {
          Plein
          }
        </div>
      </div>

      <div class="depot-card-body">
        <h3 class="depot-nom">{{ depot.nom }}</h3>
        <div class="depot-location">
          <span class="location-icon">üìç</span>
          <span>{{ depot.ville }}</span>
        </div>
        <div class="depot-adresse">{{ depot.adresse }}</div>

        <div class="depot-info">
          <div class="info-item">
            <span class="info-label">Responsable:</span>
            <span class="info-value">{{ depot.responsable }}</span>
          </div>
          <div class="info-item">
            <span class="info-label">T√©l√©phone:</span>
            <span class="info-value">{{ depot.telephone }}</span>
          </div>
          <div class="info-item">
            <span class="info-label">Date cr√©ation:</span>
            <span class="info-value">{{ depot.dateCreation }}</span>
          </div>
        </div>

        <div class="stock-section">
          <div class="stock-header">
            <span class="stock-label">Stock</span>
            <span class="stock-percentage">{{ getPourcentageStock(depot) }}%</span>
          </div>
          <div class="stock-bar-container">
            <div
              class="stock-bar"
              [class]="getPourcentageStock(depot) > 80 ? 'bar-high' : getPourcentageStock(depot) > 30 ? 'bar-medium' : 'bar-low'"
              [style.width.%]="getPourcentageStock(depot)">
            </div>
          </div>
          <div class="stock-details">
            <span>Utilis√©e: {{ (depot.stockActuel ?? depot.capaciteUtilisee ?? 0) | number }} L</span>
            <span>Restant: {{ getCapaciteRestante(depot) | number }} L</span>
            <span>Capacit√©: {{ depot.capacite | number }} L</span>
          </div>
        </div>

        <div class="produits-preview">
          <div class="produits-label">Stock par type de produit:</div>
          <div class="produits-list">
            @if (depot.produits && depot.produits.length > 0) {
              @for (produit of depot.produits; track produit.nom) {
              <div class="produit-item">
                <div class="produit-item-header">
                  <span class="produit-nom">{{ produit.nom }}</span>
                  <span class="produit-niveau" [class]="'niveau-' + produit.niveau" [title]="'Niveau: ' + produit.niveau">
                    @if (produit.niveau === 'optimal') { ‚úì Optimal }
                    @if (produit.niveau === 'faible') { ‚ö† Faible }
                    @if (produit.niveau === 'critique') { ‚ö† Critique }
                  </span>
                </div>
                <div class="produit-item-stocks">
                  <div class="stock-row stock-total">
                    <span class="stock-label">Stock</span>
                    <span class="stock-value">{{ produit.quantite | number }} {{ produit.unite }}</span>
                  </div>
                  @if (produit.quantityCession && produit.quantityCession > 0) {
                  <div class="stock-row stock-cession">
                    <span class="stock-label">Stock en cession</span>
                    <span class="stock-value">{{ produit.quantityCession | number }} {{ produit.unite }}</span>
                  </div>
                  }
                </div>
              </div>
              }
            } @else {
              <div class="produit-item empty">
                <span class="produit-nom">Aucun produit en stock</span>
              </div>
            }
          </div>
        </div>
      </div>

      @if (isLogistique) {
      <div class="depot-card-actions">
        <!-- <button class="action-btn sortie" (click)="sortirStock(depot)" title="Sortir du stock">
          <span>üì§</span>
          Sortir
        </button>
        <button class="action-btn approvisionnement" (click)="approvisionnerDepot(depot)" title="Approvisionner">
          <span>üì¶</span>
          Approvisionner
        </button> -->
        <button class="action-btn" (click)="editDepot(depot)" title="√âditer">
          <span>Modifier</span>
        </button>
        @if (isAdmin) {
        <button class="action-btn" (click)="deleteDepot(depot)" title="Supprimer">
          <span>üóëÔ∏è</span>
        </button>
        }
      </div>
      }
    </div>
      }
    }
  </div>

  @if (showAddModal) {
  <div class="modal-overlay" (click)="closeAddModal()">
    <div class="modal-content add-depot-modal" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2>Ajouter un nouveau d√©p√¥t</h2>
        <button class="modal-close" (click)="closeAddModal()" aria-label="Fermer">√ó</button>
      </div>

      <div class="modal-body">
        <form (ngSubmit)="addDepot()">
          <div class="form-row">
            <div class="form-group">
              <label for="nom">Nom du d√©p√¥t *</label>
              <input
                type="text"
                id="nom"
                [(ngModel)]="newDepot.nom"
                name="nom"
                required
                placeholder="Ex: D√©p√¥t Principal Bamako"
              />
            </div>

            <div class="form-group">
              <label for="ville">Ville *</label>
              <input
                type="text"
                id="ville"
                [(ngModel)]="newDepot.ville"
                name="ville"
                required
                placeholder="Ex: Bamako"
              />
            </div>
          </div>

          <div class="form-group">
            <label for="adresse">Adresse compl√®te *</label>
            <input
              type="text"
              id="adresse"
              [(ngModel)]="newDepot.adresse"
              name="adresse"
              required
              placeholder="Ex: Route de Koulikoro, Bamako"
            />
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="responsable">Responsable *</label>
              <input
                type="text"
                id="responsable"
                [(ngModel)]="newDepot.responsable"
                name="responsable"
                required
                placeholder="Ex: Amadou Diallo"
              />
            </div>

            <div class="form-group">
              <label for="telephone">T√©l√©phone *</label>
              <input
                type="tel"
                id="telephone"
                [(ngModel)]="newDepot.telephone"
                name="telephone"
                required
                placeholder="Ex: +223 20 12 34 56"
              />
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="capacite">Capacit√© (L) *</label>
              <input
                type="number"
                id="capacite"
                [(ngModel)]="newDepot.capacite"
                name="capacite"
                required
                min="1"
                step="1"
                placeholder="Ex: 100000"
              />
              <p class="form-hint">Capacit√© maximale de stockage en litres</p>
            </div>

            <div class="form-group">
              <label for="statut">Statut *</label>
              <select
                id="statut"
                [(ngModel)]="newDepot.statut"
                name="statut"
                required
              >
                <option value="ACTIF">Actif</option>
                <option value="INACTIF">Inactif</option>
                <option value="EN_MAINTENANCE">En maintenance</option>
              </select>
            </div>
          </div>

          <div class="form-info">
            <div class="info-box">
              <span class="info-icon">‚ÑπÔ∏è</span>
              <div class="info-content">
                <p class="info-title">Stock initial</p>
                <p class="info-text">Le stock actuel sera initialis√© √† 0. Vous pourrez ajouter des produits apr√®s la cr√©ation du d√©p√¥t.</p>
              </div>
            </div>
          </div>

          <div class="modal-actions">
            <button type="button" class="btn-cancel" (click)="closeAddModal()">
              Annuler
            </button>
            <button type="submit" class="btn-submit" [disabled]="isLoading">
              @if (isLoading) {
                Enregistrement...
              } @else {
                Ajouter le d√©p√¥t
              }
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
  }

  @if (showApprovisionnementModal && depotPourApprovisionnement) {
  <div class="modal-overlay" (click)="closeApprovisionnementModal()">
    <div class="modal-content approvisionnement-modal" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2>Approvisionner le d√©p√¥t</h2>
        <button class="modal-close" (click)="closeApprovisionnementModal()" aria-label="Fermer">√ó</button>
      </div>

      <div class="modal-body">
        <div class="depot-info-section">
          <div class="depot-info-card">
            <div class="depot-info-icon">üè≠</div>
            <div class="depot-info-details">
              <h3>{{ depotPourApprovisionnement.nom }}</h3>
              <div class="depot-info-stats">
                <div class="stat-item">
                  <span class="stat-label">Capacit√©:</span>
                  <span class="stat-value">{{ depotPourApprovisionnement.capacite | number }} L</span>
                </div>
                <div class="stat-item">
                  <span class="stat-label">Stock actuel:</span>
                  <span class="stat-value">{{ depotPourApprovisionnement.stockActuel || 0 | number }} L</span>
                </div>
                <div class="stat-item">
                  <span class="stat-label">Capacit√© restante:</span>
                  <span class="stat-value" [class.warning]="getCapaciteRestante() < 10000">
                    {{ getCapaciteRestante() | number }} L
                  </span>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="approvisionnement-section">
          <h3>Choisir un produit √† ajouter</h3>

          <form (ngSubmit)="saveApprovisionnement()">
            <div class="form-group">
              <label for="produit-id">Produit *</label>
              <select
                id="produit-id"
                [(ngModel)]="produitApprovisionnement.produitId"
                name="produit-id"
                required
                aria-label="S√©lectionner un produit"
              >
                <option [value]="undefined">S√©lectionner un produit</option>
                @for (prod of produitsDisponibles; track prod.id) {
                  <option [value]="prod.id">{{ prod.nom }} ({{ prod.typeProduit }})</option>
                }
              </select>
            </div>

            <div class="form-group">
              <label for="produit-quantite">Quantit√© ({{ getProduitUnite(produitApprovisionnement.produitId) }}) *</label>
              <input
                type="number"
                id="produit-quantite"
                [(ngModel)]="produitApprovisionnement.quantite"
                name="produit-quantite"
                min="0.01"
                step="0.01"
                placeholder="0"
                required
              />
            </div>

            <div class="form-group">
              <label for="produit-prix">Prix unitaire (FCFA)</label>
              <input
                type="number"
                id="produit-prix"
                [(ngModel)]="produitApprovisionnement.prixUnitaire"
                name="produit-prix"
                min="0"
                step="0.01"
                placeholder="0"
              />
            </div>

            <div class="form-group">
              <label for="produit-seuil">Seuil minimum</label>
              <input
                type="number"
                id="produit-seuil"
                [(ngModel)]="produitApprovisionnement.seuilMinimum"
                name="produit-seuil"
                min="0"
                step="0.01"
                placeholder="0"
              />
            </div>

            <div class="approvisionnement-summary">
              <div class="summary-item">
                <span class="summary-label">Capacit√© restante:</span>
                <span class="summary-value" [class.warning]="getCapaciteRestante() < (produitApprovisionnement.quantite || 0)">
                  {{ getCapaciteRestante() | number }} L
                </span>
              </div>
              @if (produitApprovisionnement.quantite && !canAddProduit()) {
                <div class="summary-error">
                  ‚ö†Ô∏è La quantit√© d√©passe la capacit√© restante du d√©p√¥t
                </div>
              }
            </div>
          </form>
        </div>

        <div class="modal-actions">
          <button type="button" class="btn-cancel" (click)="closeApprovisionnementModal()">
            Annuler
          </button>
          <button
            type="button"
            class="btn-submit"
            (click)="saveApprovisionnement()"
            [disabled]="isLoading || !produitApprovisionnement.produitId || !canAddProduit()"
          >
            @if (isLoading) {
              Enregistrement...
            } @else {
              Ajouter au d√©p√¥t
            }
          </button>
        </div>
      </div>
    </div>
  </div>
  }

  @if (showSortieModal && depotPourSortie) {
  <div class="modal-overlay" (click)="closeSortieModal()">
    <div class="modal-content sortie-modal" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2>Sortir du stock - {{ depotPourSortie.nom }}</h2>
        <button class="modal-close" (click)="closeSortieModal()" aria-label="Fermer">√ó</button>
      </div>

      <div class="modal-body">
        <div class="depot-info-section">
          <div class="depot-info-card">
            <div class="depot-info-icon">üì§</div>
            <div class="depot-info-details">
              <h3>{{ depotPourSortie.nom }}</h3>
              <div class="depot-info-stats">
                <div class="stat-item">
                  <span class="stat-label">Stock actuel:</span>
                  <span class="stat-value">{{ depotPourSortie.stockActuel || 0 | number }} L</span>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="sortie-section">
          <h3>Choisir un produit √† sortir</h3>

          <form (ngSubmit)="saveSortie()">
            <div class="form-group">
              <label for="stock-id">Produit *</label>
              <select
                id="stock-id"
                [(ngModel)]="produitSortie.stockId"
                name="stock-id"
                required
                aria-label="S√©lectionner un produit"
              >
                <option [ngValue]="undefined">S√©lectionner un produit</option>
                @for (stock of stocksDepot; track stock.id) {
                  <option [ngValue]="stock.id">
                    {{ stock.produitNom || 'Produit inconnu' }} - {{ stock.quantite | number }} {{ stock.unite || 'L' }} disponible(s)
                  </option>
                }
              </select>
            </div>

            @if (produitSortie.stockId) {
              <div class="stock-info-box">
                <div class="info-item">
                  <span class="info-label">Quantit√© disponible:</span>
                  <span class="info-value">{{ getQuantiteDisponible() | number }} {{ getStockSelected()?.unite || 'L' }}</span>
                </div>
              </div>
            }

            <div class="form-group">
              <label for="quantite-sortie">Quantit√© √† sortir ({{ getStockSelected()?.unite || 'L' }}) *</label>
              <input
                type="number"
                id="quantite-sortie"
                [(ngModel)]="produitSortie.quantite"
                name="quantite-sortie"
                [max]="getQuantiteDisponible()"
                min="0.01"
                step="0.01"
                placeholder="0"
                required
              />
              @if (produitSortie.stockId) {
                <p class="form-hint">Maximum: {{ getQuantiteDisponible() | number }} {{ getStockSelected()?.unite || 'L' }}</p>
              }
            </div>

            @if (produitSortie.quantite && produitSortie.quantite > getQuantiteDisponible()) {
              <div class="error-message">
                ‚ö†Ô∏è La quantit√© √† sortir d√©passe la quantit√© disponible
              </div>
            }

            @if (produitSortie.stockId && produitSortie.quantite) {
              <div class="sortie-summary">
                <div class="summary-item">
                  <span class="summary-label">Quantit√© apr√®s sortie:</span>
                  <span class="summary-value">
                    {{ (getQuantiteDisponible() - produitSortie.quantite) | number }} {{ getStockSelected()?.unite || 'L' }}
                  </span>
                </div>
              </div>
            }
          </form>
        </div>

        <div class="modal-actions">
          <button type="button" class="btn-cancel" (click)="closeSortieModal()">
            Annuler
          </button>
          <button
            type="button"
            class="btn-submit"
            (click)="saveSortie()"
            [disabled]="isLoading || !produitSortie.stockId || !canSortirStock()"
          >
            @if (isLoading) {
              Enregistrement...
            } @else {
              Sortir du stock
            }
          </button>
        </div>
      </div>
    </div>
  </div>
  }

  @if (showEditModal && selectedDepotForEdit) {
  <div class="modal-overlay" (click)="closeEditModal()">
    <div class="modal-content add-depot-modal" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2>Modifier le D√©p√¥t</h2>
        <button class="modal-close" (click)="closeEditModal()" aria-label="Fermer">√ó</button>
      </div>

      <div class="modal-body">
        <form (ngSubmit)="updateDepot()">
          <div class="form-row">
            <div class="form-group">
              <label for="edit-nom">Nom du d√©p√¥t *</label>
              <input
                type="text"
                id="edit-nom"
                [(ngModel)]="editDepotData.nom"
                name="edit-nom"
                required
                placeholder="Ex: D√©p√¥t Principal Bamako"
              />
            </div>

            <div class="form-group">
              <label for="edit-ville">Ville *</label>
              <input
                type="text"
                id="edit-ville"
                [(ngModel)]="editDepotData.ville"
                name="edit-ville"
                required
                placeholder="Ex: Bamako"
              />
            </div>
          </div>

          <div class="form-group">
            <label for="edit-adresse">Adresse compl√®te *</label>
            <input
              type="text"
              id="edit-adresse"
              [(ngModel)]="editDepotData.adresse"
              name="edit-adresse"
              required
              placeholder="Ex: Route de Koulikoro, Bamako"
            />
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="edit-responsable">Responsable *</label>
              <input
                type="text"
                id="edit-responsable"
                [(ngModel)]="editDepotData.responsable"
                name="edit-responsable"
                required
                placeholder="Ex: Amadou Diallo"
              />
            </div>

            <div class="form-group">
              <label for="edit-telephone">T√©l√©phone *</label>
              <input
                type="tel"
                id="edit-telephone"
                [(ngModel)]="editDepotData.telephone"
                name="edit-telephone"
                required
                placeholder="Ex: +223 20 12 34 56"
              />
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="edit-capacite">Capacit√© (L) *</label>
              <input
                type="number"
                id="edit-capacite"
                [(ngModel)]="editDepotData.capacite"
                name="edit-capacite"
                required
                [min]="selectedDepotForEdit.capaciteUtilisee || 0"
                step="1"
                placeholder="Ex: 100000"
              />
              <p class="form-hint">
                Capacit√© maximale de stockage en litres
                @if (selectedDepotForEdit.capaciteUtilisee && selectedDepotForEdit.capaciteUtilisee > 0) {
                  <br>Minimum: {{ selectedDepotForEdit.capaciteUtilisee | number }} L (capacit√© utilis√©e)
                }
              </p>
            </div>

            <div class="form-group">
              <label for="edit-statut">Statut *</label>
              <select
                id="edit-statut"
                [(ngModel)]="editDepotData.statut"
                name="edit-statut"
                required
              >
                <option value="ACTIF">Actif</option>
                <option value="INACTIF">Inactif</option>
                <option value="EN_MAINTENANCE">En maintenance</option>
                <option value="PLEIN">Plein</option>
              </select>
            </div>
          </div>

          <div class="form-info">
            <div class="info-box">
              <span class="info-icon">‚ÑπÔ∏è</span>
              <div class="info-content">
                <p class="info-title">Informations</p>
                <p class="info-text">
                  Stock actuel: {{ selectedDepotForEdit.capaciteUtilisee || 0 | number }} L
                  @if (selectedDepotForEdit.capaciteUtilisee && selectedDepotForEdit.capaciteUtilisee > 0) {
                    <br>La capacit√© ne peut pas √™tre inf√©rieure √† la capacit√© utilis√©e.
                  }
                </p>
              </div>
            </div>
          </div>

          <div class="modal-actions">
            <button type="button" class="btn-cancel" (click)="closeEditModal()">
              Annuler
            </button>
            <button type="submit" class="btn-submit" [disabled]="isLoading">
              @if (isLoading) {
                Mise √† jour...
              } @else {
                Mettre √† jour
              }
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
  }
</div>
