<div class="depenses-container">
  <!-- Header -->
  <div class="page-header">
    <div class="header-content">
      <h1>üí∏ Gestion des D√©penses</h1>
      <p>Suivez et g√©rez toutes vos d√©penses</p>
    </div>
    <div class="header-actions">
      <button class="btn-primary" (click)="openAddDepenseModal()">
        <span>+</span> Nouvelle D√©pense
      </button>
    </div>
  </div>

  <!-- Stats Cards -->
  <div class="stats-grid">
    <div class="stat-card">
      <div class="stat-icon blue">üìä</div>
      <div class="stat-info">
        <span class="stat-label">Total D√©penses</span>
        <span class="stat-value">{{ totalElements }}</span>
      </div>
    </div>
    <div class="stat-card">
      <div class="stat-icon green">üí∞</div>
      <div class="stat-info">
        <span class="stat-label">Montant Page</span>
        <span class="stat-value">{{ formatMontant(totalDepenses) }}</span>
      </div>
    </div>
    <div class="stat-card">
      <div class="stat-icon purple">üìÅ</div>
      <div class="stat-info">
        <span class="stat-label">Cat√©gories</span>
        <span class="stat-value">{{ categories.length }}</span>
      </div>
    </div>
  </div>

  <!-- Tabs -->
  <div class="tabs-container">
    <button 
      class="tab-btn" 
      [class.active]="activeTab === 'depenses'"
      (click)="activeTab = 'depenses'">
      üìù D√©penses
    </button>
    <button 
      class="tab-btn" 
      [class.active]="activeTab === 'categories'"
      (click)="activeTab = 'categories'">
      üìÅ Cat√©gories
    </button>
  </div>

  <!-- Depenses Tab -->
  @if (activeTab === 'depenses') {
    <!-- Filters -->
    <div class="filters-section">
      <div class="search-box">
        <span class="search-icon">üîç</span>
        <input 
          type="text" 
          [(ngModel)]="searchTerm" 
          placeholder="Rechercher une d√©pense..."
        />
      </div>
      
      <div class="filter-group">
        <select [(ngModel)]="selectedCategorieId" (change)="onFilterChange()">
          <option [ngValue]="null">Toutes les cat√©gories</option>
          @for (cat of categories; track cat.id) {
            <option [ngValue]="cat.id">{{ cat.nom }}</option>
          }
        </select>
      </div>

      <div class="filter-group">
        <select [(ngModel)]="filterType" (change)="onFilterChange()">
          <option value="none">Toutes les dates</option>
          <option value="date">Date pr√©cise</option>
          <option value="range">Intervalle</option>
        </select>
      </div>

      @if (filterType === 'date') {
        <div class="filter-group">
          <input 
            type="date" 
            [(ngModel)]="filterDate" 
            (change)="onFilterChange()"
          />
        </div>
      }

      @if (filterType === 'range') {
        <div class="filter-group date-range">
          <input 
            type="date" 
            [(ngModel)]="filterStartDate" 
            (change)="onFilterChange()"
            placeholder="Date d√©but"
          />
          <span>√†</span>
          <input 
            type="date" 
            [(ngModel)]="filterEndDate" 
            (change)="onFilterChange()"
            placeholder="Date fin"
          />
        </div>
      }

      <button class="btn-clear" (click)="clearFilters()">
        ‚úï R√©initialiser
      </button>
    </div>

    <!-- Table -->
    <div class="table-container">
      @if (isLoading) {
        <div class="loading-state">
          <div class="spinner"></div>
          <p>Chargement...</p>
        </div>
      } @else if (filteredDepenses.length === 0) {
        <div class="empty-state">
          <span class="empty-icon">üì≠</span>
          <h3>Aucune d√©pense trouv√©e</h3>
          <p>Ajoutez une nouvelle d√©pense pour commencer</p>
        </div>
      } @else {
        <table class="data-table">
          <thead>
            <tr>
              <th>Date</th>
              <th>Libell√©</th>
              <th>Cat√©gorie</th>
              <th>Source</th>
              <th>R√©f√©rence</th>
              <th>Montant</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            @for (depense of filteredDepenses; track depense.id) {
              <tr>
                <td>{{ formatDate(depense.dateDepense) }}</td>
                <td class="libelle-cell">
                  <span class="libelle">{{ depense.libelle }}</span>
                  @if (depense.description) {
                    <span class="description">{{ depense.description }}</span>
                  }
                </td>
                <td>
                  <span class="badge-categorie" [style.background-color]="getCategorieColor(depense.categorieNom || '')">
                    {{ depense.categorieNom }}
                  </span>
                </td>
                <td>{{ getSourceLabel(depense) }}</td>
                <td>{{ depense.reference || '-' }}</td>
                <td class="montant-cell">{{ formatMontant(depense.montant) }}</td>
                <td class="actions-cell">
                  <button class="action-btn edit" (click)="openEditDepenseModal(depense)" title="Modifier">
                    ‚úèÔ∏è
                  </button>
                  <button class="action-btn delete" (click)="confirmDelete('depense', depense.id!)" title="Supprimer">
                    üóëÔ∏è
                  </button>
                </td>
              </tr>
            }
          </tbody>
        </table>

        <!-- Pagination -->
        @if (totalPages > 1) {
          <div class="pagination">
            <button 
              class="page-btn" 
              [disabled]="currentPage === 0"
              (click)="goToPage(0)">
              ‚â™
            </button>
            <button 
              class="page-btn" 
              [disabled]="currentPage === 0"
              (click)="goToPage(currentPage - 1)">
              ‚Äπ
            </button>
            
            @for (page of pages; track page) {
              <button 
                class="page-btn"
                [class.active]="page === currentPage"
                (click)="goToPage(page)">
                {{ page + 1 }}
              </button>
            }
            
            <button 
              class="page-btn" 
              [disabled]="currentPage === totalPages - 1"
              (click)="goToPage(currentPage + 1)">
              ‚Ä∫
            </button>
            <button 
              class="page-btn" 
              [disabled]="currentPage === totalPages - 1"
              (click)="goToPage(totalPages - 1)">
              ‚â´
            </button>
            
            <span class="page-info">
              Page {{ currentPage + 1 }} sur {{ totalPages }} ({{ totalElements }} √©l√©ments)
            </span>
          </div>
        }
      }
    </div>
  }

  <!-- Categories Tab -->
  @if (activeTab === 'categories') {
    <div class="categories-header">
      <button class="btn-primary" (click)="openAddCategorieModal()">
        <span>+</span> Nouvelle Cat√©gorie
      </button>
    </div>

    <div class="categories-grid">
      @for (categorie of categories; track categorie.id) {
        <div class="categorie-card">
          <div class="categorie-header">
            <span class="categorie-icon" [style.background-color]="getCategorieColor(categorie.nom)">
              üìÅ
            </span>
            <div class="categorie-info">
              <h3>{{ categorie.nom }}</h3>
              @if (categorie.description) {
                <p>{{ categorie.description }}</p>
              }
            </div>
          </div>
          <div class="categorie-footer">
            <span class="status-badge" [class.active]="categorie.statut === 'ACTIF'">
              {{ categorie.statut }}
            </span>
            <div class="categorie-actions">
              <button class="action-btn edit" (click)="openEditCategorieModal(categorie)">
                ‚úèÔ∏è
              </button>
              <button class="action-btn delete" (click)="confirmDelete('categorie', categorie.id!)">
                üóëÔ∏è
              </button>
            </div>
          </div>
        </div>
      }

      @if (categories.length === 0) {
        <div class="empty-state full-width">
          <span class="empty-icon">üìÅ</span>
          <h3>Aucune cat√©gorie</h3>
          <p>Cr√©ez une cat√©gorie pour organiser vos d√©penses</p>
        </div>
      }
    </div>
  }
</div>

<!-- Modal D√©pense -->
@if (showDepenseModal) {
  <div class="modal-overlay" (click)="closeDepenseModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2>{{ isEditingDepense ? 'Modifier la d√©pense' : 'Nouvelle d√©pense' }}</h2>
        <button class="close-btn" (click)="closeDepenseModal()">‚úï</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label>Libell√© *</label>
          <input type="text" [(ngModel)]="depenseForm.libelle" placeholder="Ex: Achat carburant" />
        </div>
        <div class="form-row">
          <div class="form-group">
            <label>Montant *</label>
            <input type="number" [(ngModel)]="depenseForm.montant" placeholder="0" min="0" />
          </div>
          <div class="form-group">
            <label>Date *</label>
            <input type="date" [(ngModel)]="depenseForm.dateDepense" />
          </div>
        </div>
        <div class="form-group">
          <label>Cat√©gorie *</label>
          <select [(ngModel)]="depenseForm.categorieId">
            <option [ngValue]="undefined">S√©lectionner une cat√©gorie</option>
            @for (cat of categories; track cat.id) {
              <option [ngValue]="cat.id">{{ cat.nom }}</option>
            }
          </select>
        </div>
        <div class="form-group source-paiement">
          <label>Source du paiement {{ isEditingDepense ? '' : '*' }}</label>
          <div class="source-options">
            <label class="radio-option">
              <input type="radio" name="sourceType" [value]="'compte'" [(ngModel)]="sourceType" (change)="onSourceTypeChange()" />
              <span>Compte bancaire</span>
            </label>
            <label class="radio-option">
              <input type="radio" name="sourceType" [value]="'caisse'" [(ngModel)]="sourceType" (change)="onSourceTypeChange()" />
              <span>Caisse</span>
            </label>
          </div>
          @if (sourceType === 'compte') {
            <select [(ngModel)]="depenseForm.compteId" class="source-select">
              <option [ngValue]="undefined">Choisir un compte</option>
              @for (c of comptes; track c.id) {
                @if (c.statut === 'ACTIF') {
                  <option [ngValue]="c.id">{{ c.banque }} - {{ c.numero }}</option>
                }
              }
            </select>
          }
          @if (sourceType === 'caisse') {
            <select [(ngModel)]="depenseForm.caisseId" class="source-select">
              <option [ngValue]="undefined">Choisir une caisse</option>
              @for (c of caisses; track c.id) {
                @if (c.statut === 'ACTIF') {
                  <option [ngValue]="c.id">{{ c.nom }}</option>
                }
              }
            </select>
          }
        </div>
        <div class="form-group">
          <label>R√©f√©rence</label>
          <input type="text" [(ngModel)]="depenseForm.reference" placeholder="Ex: FAC-2024-001" />
        </div>
        <div class="form-group">
          <label>Description</label>
          <textarea [(ngModel)]="depenseForm.description" placeholder="Description optionnelle..." rows="3"></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn-secondary" (click)="closeDepenseModal()">Annuler</button>
        <button class="btn-primary" (click)="saveDepense()">
          {{ isEditingDepense ? 'Modifier' : 'Enregistrer' }}
        </button>
      </div>
    </div>
  </div>
}

<!-- Modal Cat√©gorie -->
@if (showCategorieModal) {
  <div class="modal-overlay" (click)="closeCategorieModal()">
    <div class="modal-content modal-small" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2>{{ isEditingCategorie ? 'Modifier la cat√©gorie' : 'Nouvelle cat√©gorie' }}</h2>
        <button class="close-btn" (click)="closeCategorieModal()">‚úï</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label>Nom *</label>
          <input type="text" [(ngModel)]="categorieForm.nom" placeholder="Ex: Carburant" />
        </div>
        <div class="form-group">
          <label>Description</label>
          <textarea [(ngModel)]="categorieForm.description" placeholder="Description optionnelle..." rows="2"></textarea>
        </div>
        <div class="form-group">
          <label>Statut</label>
          <select [(ngModel)]="categorieForm.statut">
            <option value="ACTIF">Actif</option>
            <option value="INACTIF">Inactif</option>
          </select>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn-secondary" (click)="closeCategorieModal()">Annuler</button>
        <button class="btn-primary" (click)="saveCategorie()">
          {{ isEditingCategorie ? 'Modifier' : 'Enregistrer' }}
        </button>
      </div>
    </div>
  </div>
}

<!-- Modal Confirmation Suppression -->
@if (showDeleteConfirm) {
  <div class="modal-overlay" (click)="cancelDelete()">
    <div class="modal-content modal-small" (click)="$event.stopPropagation()">
      <div class="modal-header warning">
        <h2>‚ö†Ô∏è Confirmation</h2>
        <button class="close-btn" (click)="cancelDelete()">‚úï</button>
      </div>
      <div class="modal-body">
        <p class="confirm-text">
          √ätes-vous s√ªr de vouloir supprimer {{ itemToDelete?.type === 'depense' ? 'cette d√©pense' : 'cette cat√©gorie' }} ?
        </p>
        <p class="confirm-warning">Cette action est irr√©versible.</p>
      </div>
      <div class="modal-footer">
        <button class="btn-secondary" (click)="cancelDelete()">Annuler</button>
        <button class="btn-danger" (click)="executeDelete()">Supprimer</button>
      </div>
    </div>
  </div>
}

